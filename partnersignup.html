<!-- ... tutto invariato sopra ... -->
  <!-- FORM POPUP -->
  <div id="form-popup">
    <div class="form-content" id="form-step1">
      <button class="close" onclick="closeForm()">&times;</button>
      <div class="form-stepper">
        <div class="step-icon active">1</div>
        <span class="step-label">di 3</span>
        <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" height="26" style="margin-left:8px;">
      </div>
      <h2>Dati di Contatto</h2>
      <form id="leadForm" onsubmit="event.preventDefault(); submitLead();">
        <input type="text" id="nome" placeholder="Nome" required>
        <input type="text" id="citta" placeholder="CittÃ " required>
        <input type="email" id="email" placeholder="Email" required>
        <button type="submit">Avanti</button>
      </form>
      <div id="form-message" style="margin-top:8px;font-size:.99rem;"></div>
    </div>
    <!-- ... step 2 e 3 invariati ... -->
    <div class="form-content" id="form-step2" style="display:none;">
      <button class="close" onclick="closeForm()">&times;</button>
      <div class="form-stepper">
        <div class="step-icon active">2</div>
        <span class="step-label">di 3</span>
        <img src="https://cdn-icons-png.flaticon.com/512/3595/3595455.png" height="26" style="margin-left:8px;">
      </div>
      <h2>Grazie!</h2>
      <p>Questa era una prova.<br>Verrai contattato in modo esclusivo tra i primi 1000 utilizzatori.</p>
      <button onclick="nextStep()">Avanti</button>
    </div>
    <div class="form-content" id="form-step3" style="display:none;">
      <button class="close" onclick="closeForm()">&times;</button>
      <div class="form-stepper">
        <div class="step-icon active">3</div>
        <span class="step-label">di 3</span>
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" height="26" style="margin-left:8px;">
      </div>
      <h2>Attendi!</h2>
      <p>Stiamo elaborando la tua richiesta.<br>Riceverai presto una risposta dal nostro team.</p>
      <button onclick="closeForm()">Chiudi</button>
    </div>
  </div>
  <script>
    function openForm() {
      document.getElementById('form-popup').classList.add('visible');
      document.getElementById('form-step1').style.display = '';
      document.getElementById('form-step2').style.display = 'none';
      document.getElementById('form-step3').style.display = 'none';
    }
    function closeForm() {
      document.getElementById('form-popup').classList.remove('visible');
    }
    function nextStep() {
      if (document.getElementById('form-step1').style.display !== 'none') {
        document.getElementById('form-step1').style.display = 'none';
        document.getElementById('form-step2').style.display = '';
      } else if (document.getElementById('form-step2').style.display !== 'none') {
        document.getElementById('form-step2').style.display = 'none';
        document.getElementById('form-step3').style.display = '';
      }
    }
    document.querySelectorAll('.open-form').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        openForm();
      });
    });

    // INTEGRA LA CHIAMATA ALL'API
    async function submitLead() {
      const nome = document.getElementById('nome').value.trim();
      const citta = document.getElementById('citta').value.trim();
      const email = document.getElementById('email').value.trim();
      const msg = document.getElementById('form-message');
      msg.textContent = '';
      try {
        const response = await fetch('/api/send-lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome, citta, email })
        });
        const result = await response.json();
        if (result.success) {
          msg.style.color = '#28a745';
          msg.textContent = 'Richiesta inviata! Grazie.';
          // passa allo step 2 dopo breve delay
          setTimeout(() => { nextStep(); }, 800);
          document.getElementById('leadForm').reset();
        } else {
          msg.style.color = '#c0392b';
          msg.textContent = 'Errore invio: ' + (result.error || 'Riprova');
        }
      } catch (err) {
        msg.style.color = '#c0392b';
        msg.textContent = 'Errore di connessione, riprova.';
      }
    }
  </script>
</body>
</html>
